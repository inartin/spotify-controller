<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Controller</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #121212;
            color: white;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #login-container {
            text-align: center;
            padding: 20px;
        }
        #player-container {
            display: none;
            width: 100%;
            max-width: 800px;
            text-align: center;
        }
        .hidden {
            display: none !important;
        }
        button {
            background-color: #1DB954;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #1ed760;
        }
        #album-art {
            width: 300px;
            height: 300px;
            margin: 20px auto;
            box-shadow: 0 4px 60px rgba(0, 0, 0, 0.5);
            border-radius: 8px;
        }
        #track-info {
            margin-bottom: 20px;
        }
        #track-name {
            font-size: 24px;
            margin-bottom: 5px;
        }
        #artist-name {
            font-size: 18px;
            color: #b3b3b3;
        }
        #controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }
        .setup-instructions {
            background-color: #282828;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            max-width: 600px;
            text-align: left;
        }
        .setup-instructions code {
            background-color: #121212;
            padding: 2px 5px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="login-container">
        <h1>Spotify Controller</h1>
            <div class="setup-instructions">
                <h2>First-time Setup:</h2>
                <ol>
                    <li>Create a Spotify Developer application at 
                    <a href="https://developer.spotify.com/dashboard" target="_blank">developer.spotify.com/dashboard</a></li>
                    <li>Set the Redirect URI to your current URL: <code id="redirect-uri">loading...</code>
                        <button id="copy-uri" style="padding: 2px 8px; margin-left: 5px;">Copy</button>
                    </li>
                    <li>Copy your Client ID</li>
                    <li>You can either:
                        <ul>
                            <li>Enter it below and click "Save Client ID", or</li>
                            <li>Append it to the URL like: <code id="url-example">loading...</code></li>
                        </ul>
                    </li>
                </ol>
            </div>
        <div>
            <input type="text" id="client-id-input" placeholder="Enter your Spotify Client ID">
            <button id="save-client-id">Save Client ID</button>
        </div>
        <button id="login-button" class="hidden">Connect to Spotify</button>
    </div>

    <div id="player-container">
        <div id="album-art"></div>
        <div id="track-info">
            <div id="track-name">Not Playing</div>
            <div id="artist-name">-</div>
        </div>
        <div id="controls">
            <button id="prev-button">Previous</button>
            <button id="play-button">Play</button>
            <button id="pause-button">Pause</button>
            <button id="next-button">Next</button>
        </div>
    </div>

    <script>
        // Authentication & Authorization
        const SPOTIFY_AUTH_ENDPOINT = 'https://accounts.spotify.com/authorize';
        const SPOTIFY_TOKEN_ENDPOINT = 'https://accounts.spotify.com/api/token';
        const SPOTIFY_API_ENDPOINT = 'https://api.spotify.com/v1';
        const SCOPES = [
            'user-read-private',
            'user-read-currently-playing',
            'user-read-playback-state',
            'user-modify-playback-state'
        ];
        
        // Generate a random string for the state parameter
        function generateRandomString(length) {
            let text = '';
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }
        
        // Generate a code verifier (random string between 43-128 chars)
        function generateCodeVerifier() {
            return generateRandomString(128);
        }
        
        // Generate code challenge from verifier using SHA-256
        async function generateCodeChallenge(codeVerifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(codeVerifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            
            return btoa(String.fromCharCode(...new Uint8Array(digest)))
                .replace(/=/g, '')
                .replace(/\+/g, '-')
                .replace(/\//g, '_');
        }
        
        // DOM Elements
const loginContainer = document.getElementById('login-container');
const playerContainer = document.getElementById('player-container');
const clientIdInput = document.getElementById('client-id-input');
const saveClientIdButton = document.getElementById('save-client-id');
const loginButton = document.getElementById('login-button');
const redirectUriElement = document.getElementById('redirect-uri');
const prevButton = document.getElementById('prev-button');
const playButton = document.getElementById('play-button');
const pauseButton = document.getElementById('pause-button');
const nextButton = document.getElementById('next-button');
const albumArt = document.getElementById('album-art');
const trackName = document.getElementById('track-name');
const artistName = document.getElementById('artist-name');

// Get the base URL for redirect URI
const baseUrl = window.location.origin + window.location.pathname;

// Set the redirect URI text and URL example
redirectUriElement.textContent = baseUrl;
const urlExample = document.getElementById('url-example');
urlExample.textContent = baseUrl + '#client_id=YOUR_CLIENT_ID';
        
        // Check URL hash for client ID first
        let clientId;
        const urlParams = new URLSearchParams(window.location.hash.substring(1));
        const urlClientId = urlParams.get('client_id');
        
        if (urlClientId) {
            // Found client ID in URL, save it to localStorage
            clientId = urlClientId;
            localStorage.setItem('spotify_client_id', clientId);
            // Remove hash from URL without page reload
            history.replaceState(null, null, window.location.pathname);
            clientIdInput.value = clientId;
            loginButton.classList.remove('hidden');
        } else {
            // Check localStorage as fallback
            clientId = localStorage.getItem('spotify_client_id');
            if (clientId) {
                clientIdInput.value = clientId;
                loginButton.classList.remove('hidden');
            }
        }
        
        // Save Client ID to localStorage
        saveClientIdButton.addEventListener('click', () => {
            const newClientId = clientIdInput.value.trim();
            if (newClientId) {
                localStorage.setItem('spotify_client_id', newClientId);
                clientId = newClientId;
                loginButton.classList.remove('hidden');
                alert('Client ID saved successfully!');
            } else {
                alert('Please enter a valid Client ID');
            }
        });
        
        // Handle Login
        loginButton.addEventListener('click', async () => {
            if (!clientId) {
                alert('Please enter your Spotify Client ID first');
                return;
            }
            
            // Generate and store PKCE code verifier
            const codeVerifier = generateCodeVerifier();
            localStorage.setItem('spotify_code_verifier', codeVerifier);
            
            // Generate code challenge from verifier
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            
            // Generate state parameter
            const state = generateRandomString(16);
            localStorage.setItem('spotify_auth_state', state);
            
            const authUrl = new URL(SPOTIFY_AUTH_ENDPOINT);
            const params = {
                client_id: clientId,
                redirect_uri: baseUrl,
                scope: SCOPES.join(' '),
                response_type: 'code',
                code_challenge_method: 'S256',
                code_challenge: codeChallenge,
                state: state,
                show_dialog: true
            };
            
            authUrl.search = new URLSearchParams(params).toString();
            window.location.href = authUrl.toString();
        });
        
        // Parse query parameters from URL
        function getQueryParams() {
            const queryParams = {};
            const queryString = window.location.search.substring(1);
            
            if (!queryString) {
                return queryParams;
            }
            
            queryString.split('&').forEach(pair => {
                const [key, value] = pair.split('=');
                queryParams[key] = decodeURIComponent(value);
            });
            
            return queryParams;
        }
        
        // Exchange authorization code for an access token
        async function exchangeCodeForToken(code) {
            const clientId = localStorage.getItem('spotify_client_id');
            const codeVerifier = localStorage.getItem('spotify_code_verifier');
            
            if (!clientId || !codeVerifier) {
                throw new Error('Missing client ID or code verifier');
            }
            
            const params = new URLSearchParams();
            params.append('client_id', clientId);
            params.append('grant_type', 'authorization_code');
            params.append('code', code);
            params.append('redirect_uri', baseUrl);
            params.append('code_verifier', codeVerifier);
            
            const response = await fetch(SPOTIFY_TOKEN_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: params
            });
            
            if (!response.ok) {
                throw new Error(`Token request failed: ${response.status}`);
            }
            
            return await response.json();
        }
        
        // Initialize app
        async function initApp() {
            // Check if we have a code in the URL (redirect from Spotify auth)
            const queryParams = getQueryParams();
            const code = queryParams.code;
            const state = queryParams.state;
            const error = queryParams.error;
            
            // Check for errors
            if (error) {
                console.error(`Authorization error: ${error}`);
                alert(`Authorization failed: ${error}`);
                return;
            }
            
            // Check for authorization code
            if (code) {
                try {
            // Remove the code from the URL without changing the base URL
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.delete('code');
            currentUrl.searchParams.delete('state');
            window.history.replaceState({}, document.title, currentUrl.toString());
                    
                    // Verify state parameter
                    const storedState = localStorage.getItem('spotify_auth_state');
                    if (state !== storedState) {
                        throw new Error('State mismatch, possible CSRF attack');
                    }
                    
                    // Exchange the code for an access token
                    const data = await exchangeCodeForToken(code);
                    
                    // Store token and expiration
                    const accessToken = data.access_token;
                    const refreshToken = data.refresh_token;
                    const expiresIn = data.expires_in;
                    const tokenTimestamp = Date.now();
                    
                    localStorage.setItem('spotify_access_token', accessToken);
                    localStorage.setItem('spotify_refresh_token', refreshToken);
                    localStorage.setItem('spotify_token_timestamp', tokenTimestamp);
                    localStorage.setItem('spotify_token_expires_in', expiresIn);
                    
                    // Show player UI
                    loginContainer.style.display = 'none';
                    playerContainer.style.display = 'block';
                    
                    // Set up player
                    setupPlayer(accessToken);
                    return;
                } catch (error) {
                    console.error('Error exchanging code for token:', error);
                    alert(`Authentication error: ${error.message}`);
                }
            }
            
            // If no code in URL, check if we have a valid stored token
            const storedToken = localStorage.getItem('spotify_access_token');
            const storedTimestamp = localStorage.getItem('spotify_token_timestamp');
            const storedExpiresIn = localStorage.getItem('spotify_token_expires_in');
            
            if (storedToken && storedTimestamp && storedExpiresIn) {
                const now = Date.now();
                const elapsed = (now - storedTimestamp) / 1000;
                
                if (elapsed < storedExpiresIn) {
                    // Token still valid
                    loginContainer.style.display = 'none';
                    playerContainer.style.display = 'block';
                    
                    // Set up player
                    setupPlayer(storedToken);
                    return;
                } else {
                    // Token expired, try to refresh it
                    try {
                        await refreshAccessToken();
                        
                        // If refresh successful, set up player
                        loginContainer.style.display = 'none';
                        playerContainer.style.display = 'block';
                        
                        setupPlayer(localStorage.getItem('spotify_access_token'));
                        return;
                    } catch (error) {
                        console.error('Error refreshing token:', error);
                        // If refresh fails, we'll continue to show login screen
                    }
                }
            }
            
            // If we reach here, we need to login again
            loginContainer.style.display = 'block';
            playerContainer.style.display = 'none';
        }
        
        // Refresh the access token using the refresh token
        async function refreshAccessToken() {
            const clientId = localStorage.getItem('spotify_client_id');
            const refreshToken = localStorage.getItem('spotify_refresh_token');
            
            if (!clientId || !refreshToken) {
                throw new Error('Missing client ID or refresh token');
            }
            
            const params = new URLSearchParams();
            params.append('client_id', clientId);
            params.append('grant_type', 'refresh_token');
            params.append('refresh_token', refreshToken);
            
            const response = await fetch(SPOTIFY_TOKEN_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: params
            });
            
            if (!response.ok) {
                throw new Error(`Refresh token request failed: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Update stored tokens
            localStorage.setItem('spotify_access_token', data.access_token);
            localStorage.setItem('spotify_token_timestamp', Date.now());
            localStorage.setItem('spotify_token_expires_in', data.expires_in);
            
            // If a new refresh token is provided, update it
            if (data.refresh_token) {
                localStorage.setItem('spotify_refresh_token', data.refresh_token);
            }
            
            return data;
        }
        
        // Set up player functionality
        function setupPlayer(token) {
            // Set up event listeners for player controls
            prevButton.addEventListener('click', () => {
                spotifyApiCall('POST', '/me/player/previous');
                setTimeout(getCurrentlyPlaying, 500);
            });
            
            playButton.addEventListener('click', () => {
                spotifyApiCall('PUT', '/me/player/play');
                setTimeout(getCurrentlyPlaying, 500);
            });
            
            pauseButton.addEventListener('click', () => {
                spotifyApiCall('PUT', '/me/player/pause');
                setTimeout(getCurrentlyPlaying, 500);
            });
            
            nextButton.addEventListener('click', () => {
                spotifyApiCall('POST', '/me/player/next');
                setTimeout(getCurrentlyPlaying, 500);
            });
            
            // Start polling for current track
            getCurrentlyPlaying();
            setInterval(getCurrentlyPlaying, 5000);
        }
        
        // Make API calls to Spotify
        async function spotifyApiCall(method, endpoint, body = null) {
            const token = localStorage.getItem('spotify_access_token');
            
            try {
                const response = await fetch(`${SPOTIFY_API_ENDPOINT}${endpoint}`, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: body ? JSON.stringify(body) : null
                });
                
                if (response.status === 401) {
                    // Token expired
                    localStorage.removeItem('spotify_access_token');
                    alert('Your session has expired. Please log in again.');
                    window.location.reload();
                    return null;
                }
                
                if (response.status === 204) {
                    return true; // Success but no content
                }
                
                if (response.ok) {
                    // Only try to parse as JSON if there's content
                    if (response.status !== 204) {
                        const text = await response.text();
                        // Check if there's any content to parse
                        if (!text) return null;
                        
                        try {
                            // Check if the response starts with a valid JSON character
                            if (text.trim().startsWith('{') || text.trim().startsWith('[')) {
                                return JSON.parse(text);
                            } else {
                                console.log('Non-JSON response:', text);
                                return null;
                            }
                        } catch (parseError) {
                            console.error('JSON Parse Error:', parseError);
                            console.log('Response text:', text);
                            return null;
                        }
                    }
                    return true;
                } else {
                    console.error('API Error:', response.status);
                    return null;
                }
            } catch (error) {
                console.error('API Request Failed:', error);
                return null;
            }
        }
        
        // Track state to avoid unnecessary UI updates
        let currentTrackId = null;
        let currentPlayState = null;
        
        // Get and display currently playing track
        async function getCurrentlyPlaying() {
            try {
                const data = await spotifyApiCall('GET', '/me/player/currently-playing');
                
                // Only update UI if we have valid data
                if (data && data.item) {
                    // Check if it's the same track to avoid unnecessary updates
                    if (currentTrackId !== data.item.id || currentPlayState !== data.is_playing) {
                        // Store current state
                        currentTrackId = data.item.id;
                        currentPlayState = data.is_playing;
                        
                        // Update UI with track info
                        trackName.textContent = data.item.name;
                        artistName.textContent = data.item.artists.map(artist => artist.name).join(', ');
                        
                        // Update album art only if we have valid images
                        if (data.item.album && data.item.album.images && data.item.album.images.length > 0) {
                            // Pre-load the image before updating the DOM
                            const img = new Image();
                            img.onload = () => {
                                albumArt.innerHTML = `<img src="${data.item.album.images[0].url}" alt="Album Art" style="width:100%; height:100%; border-radius:8px;">`;
                            };
                            img.src = data.item.album.images[0].url;
                        }
                    }
                } else if (currentTrackId !== null) {
                    // Only update if we're transitioning from playing to not playing
                    currentTrackId = null;
                    currentPlayState = null;
                    trackName.textContent = 'Not Playing';
                    artistName.textContent = '-';
                    albumArt.innerHTML = '';
                }
            } catch (error) {
                console.error('Error updating player:', error);
                // Don't update UI on errors to prevent flickering
            }
        }
        
        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
